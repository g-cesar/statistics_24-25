<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptography analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        canvas#background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #000;
        }
    
        .glassCard{
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            height: max-content;
        }
  
        .glassChart{
          background: rgba(0, 0, 0, 0.85);
          border-radius: 16px;
          box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.3);
          height: calc(max-content + 2rem);
      }
    
        .glassHeader{
            background: rgba(0, 132, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            height: max-content;
        }
    </style>
</head>
<body class="h-svh">
    <nav class="glassHeader w-full fixed top-0 start-0 z-10">
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
          <a href="#" class="text-white">
            <h1 class="text-3xl font-bold">Guido Cesarano - 1803991</h1>
            <h2 class="text-2xl font-semibold">Statistics Course a.a. 24/25</h2>
          </a>
        </div>
    </nav>
    <canvas id="background"></canvas>
    <main class="mt-32 mb-4 mx-4">
        <div class="glassCard shadow rounded-lg p-8">
            <h1 class="text-2xl font-bold text-white text-center">Cryptography Analyzer</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex justify-center flex-col">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-white mb-2">Select Encryption Method:</label>
                        <select id="encryptionMethod" class="bg-gray-50 border border-gray-300 text-blue-600 text-sm rounded-lg focus:ring-white focus:border-white block w-full p-2.5">
                            <option value="caesar">Caesar Cipher</option>
                            <option value="modexp">Modular Exponential Cipher</option>
                            <option value="modexp_secure">Randomized Modular Exponential Cipher</option>
                        </select>
                    </div>
                    <div id="cipherParameters" class="mb-4">
                        <!-- Parameters will be dynamically added here -->
                    </div>
                    <textarea 
                        id="originalText" 
                        class="w-full mt-4 h-24 p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-white focus:border-white"
                        placeholder="Enter text to encrypt..."
                    ></textarea>
                    <button 
                        onclick="processText()" 
                        class="text-blue-600 bg-white hover:bg-blue-100 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mt-4"
                    >
                        Analyze and Encrypt
                    </button>
                </div>
                <div class="mt-2 h-[300px]">
                    <canvas class="glassChart" style="width: 100%; height: 80%;" id="originalChart"></canvas>
                    <p class="text-sm font-medium text-white mt-1 mb-1">Letter frequencies in English:</p>
                    <div class="overflow-x-auto shadow-md rounded-lg glassChart">
                        <table class="min-w-full">
                            <tr class="text-white">
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">e</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">t</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">a</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">o</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">i</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">n</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">s</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">r</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">h</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">d</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">l</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">u</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">c</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">m</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">f</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">y</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">w</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">g</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">p</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">b</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">v</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">k</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">x</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">q</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">j</th>
                                <th class="px-2 py-1 text-xs font-semibold uppercase border border-gray-800">z</th>
                            </tr>
                            <tr class="text-gray-300">
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">12.02</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">9.10</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">8.12</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">7.68</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">7.31</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">6.95</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">6.28</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">6.02</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">5.92</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">4.32</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">3.98</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.88</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.71</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.61</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.30</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.11</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.09</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">2.03</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">1.82</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">1.49</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">1.11</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">0.69</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">0.17</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">0.11</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">0.10</td>
                                <td class="px-2 py-1 text-xs text-center border border-gray-800">0.07</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="glassCard shadow rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-white mb-4">Encrypted Text</h2>
                <div id="encryptedText" class="p-4 bg-gray-50 rounded-md text-gray-700"></div>
            </div>
            <div class="glassCard shadow rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-white mb-4">Frequency distribution of the encrypted text</h2>
                <div class="mt-2 h-[300px]">
                    <canvas class="glassChart" style="width: 100%; height: 80%;" id="encryptedChart"></canvas>
                </div>
            </div>
        </div>
        <div class="glassCard shadow rounded-lg shadow-md my-4 p-6">
            <h2 class="text-2xl font-semibold text-white mb-4">Decryption attempt</h2>
            <div id="decryptedText" class="font-mono p-4 bg-gray-50 rounded-md text-gray-700"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glassCard shadow rounded-lg shadow-md my-4 p-6">
                <section class="mb-6 text-white">
                    <h2 class="text-2xl font-semibold mb-3">Caesar Cipher</h2>
                    <ul class="list-disc ml-6 space-y-2">
                        <li>Simple substitution cipher that shifts each character by a fixed number of positions</li>
                        <li>It is a monoalphabetic cipher</li>
                    </ul>
                </section>
                <section class="mb-6 text-white">
                    <h2 class="text-2xl font-semibold mb-3">ModExp Cipher</h2>
                    <ul class="list-disc ml-6 space-y-2">
                        <li>Implements cryptographic operations based on modular arithmetic</li>
                        <li>Uses a public key consisting of a modulus (<code>N</code>) and an exponent (<code>K</code>)</li>
                    </ul>
                </section>
            </div>
            <div class="glassCard shadow rounded-lg shadow-md my-4 p-6">
                <section class="mb-6 text-white">
                    <h2 class="text-2xl font-semibold mb-3">Statistical Analysis in Cryptography</h2>
                    <article class="mb-4">
                        <h3 class="text-xl font-semibold mb-2">Caesar Cipher</h3>
                        <p class="mb-2">Extremely vulnerable to statistical analysis because:</p>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Maintains the relative frequency of characters</li>
                            <li>The most common letters in English (eg.: <code>E</code>, <code>T</code>, <code>A</code>, <code>O</code>) remain identifiable</li>
                            <li>A few lines of text are enough to determine the shift</li>
                        </ul>
                    </article>
                </section>
                <section class="mb-6 text-white">
                    <h2 class="text-2xl font-semibold mb-3">ModExp Cipher</h2>
                    <article class="mb-4">
                        <p class="mb-2">Vulnerable to frequency analysis, as each character is always mapped to the same value</p>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Transforms characters deterministically (the same input always produces the same output)</li>
                            <li>Maintains a 1:1 mapping between input and output characters</li>
                            <li>It is possible to construct a mapping table by observing input-output correspondences</li>
                        </ul>
                        <p class="mt-2 text-yellow-200">
                            <strong>Note:</strong> For actual security, the following should be applied:
                        </p>
                        <ul class="list-disc ml-6 space-y-2 text-yellow-100">
                            <li>Random elements (salt) for each message</li>
                            <li>Proper padding</li>
                            <li>Standard algorithms like RSA with verified implementations</li>
                        </ul>
                    </article>
                </section>
            </div>
            <div class="glassCard shadow rounded-lg shadow-md my-4 p-6">
                <section class="mb-6 text-white">
                    <h2 class="text-2xl font-semibold mb-3">RSA vs Implemented Algorithms</h2>
                    <p class="mb-4">RSA differs in:</p>
        
                    <article class="mb-4">
                        <h3 class="text-xl font-semibold mb-2">Mathematical Security</h3>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Based on the difficulty of factoring large numbers</li>
                            <li>Uses keys of much greater length (2048+ bits)</li>
                        </ul>
                    </article>
        
                    <article class="mb-4">
                        <h3 class="text-xl font-semibold mb-2">Key Structure</h3>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Pair of asymmetric keys (public/private)</li>
                            <li>The private key cannot be derived from the public key</li>
                        </ul>
                    </article>
        
                    <article>
                        <h3 class="text-xl font-semibold mb-2">Computational Complexity</h3>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Requires very large prime numbers</li>
                            <li>More complex operations compared to simple modExp</li>
                        </ul>
                    </article>
                </section>
            </div>
        </div>
    </main>

    <script>
        
        // Calcolo della potenza modulare (N^k % P)
        function modPow(base, exponent, modulus) {
            if (modulus === 1) return 0;
            
            let result = 1;
            base = base % modulus;
            
            while (exponent > 0) {
                if (exponent % 2 === 1) {
                    result = (result * base) % modulus;
                }
                base = (base * base) % modulus;
                exponent = Math.floor(exponent / 2);
            }
            
            return result;
        }

        // Calcolo dell'inverso moltiplicativo mod P
        // Algoritmo esteso di Euclide per calcolare l'inverso modulo
        function modInverse(a, m) {
            let m0 = m;
            let x0 = 0;
            let x1 = 1;
            
            if (m == 1) return 0;
            
            while (a > 1) {
                let q = Math.floor(a / m);
                let t = m;
                
                m = a % m;
                a = t;
                t = x0;
                
                x0 = x1 - q * x0;
                x1 = t;
            }
            
            if (x1 < 0) x1 += m0;
            
            return x1;
        }

        function updateParameters() {
            const method = document.getElementById('encryptionMethod').value;
            const container = document.getElementById('cipherParameters');
            container.innerHTML = '';

            if (method === 'caesar') {
                container.innerHTML = `
                    <label class="block text-sm font-medium text-white mb-2">Shift (1-25):</label>
                    <input type="number" id="shift" min="1" max="25" value="${Math.floor(Math.random() * 25) + 1}" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                `;
            } else if (method === 'modexp' || method === 'modexp_secure') {
                container.innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Base (N):</label>
                            <input type="number" id="base" value="10" 
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Modulus (P):</label>
                            <input type="number" id="modulus" value="37" 
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Exponent (k):</label>
                            <input type="number" id="exponent" value="7" 
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                    </div>
                `;
            }
        }

        document.getElementById('encryptionMethod').addEventListener('change', updateParameters);

        function caesarCipher(text, shift) {
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            return text.toLowerCase().split('').map(char => {
                const idx = alphabet.indexOf(char);
                if (idx === -1) return char;
                return alphabet[(idx + shift) % alphabet.length];
            }).join('');
        }
        
        function modExpCipher(text, base, exponent, modulus, method) {
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            return text.toLowerCase().split('').map(char => {
                const idx = alphabet.indexOf(char);
                if (idx === -1) return char;
                
                let encrypted = modPow(idx, exponent, modulus);

                if(method === 'modexp_secure'){
                    // Cifratura RSA: C = P^k mod N
                    encrypted = (modPow(idx, exponent, modulus) + Math.floor(Math.random() * 10)) % modulus;
                }
                
                return encrypted.toString();
            }).join(' ');
        }

        function decryptModExp(text, base, exponent, modulus, method) {
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            const invExponent = modInverse(exponent, (modulus-1));

            return text.split(' ').map(char => {
                if (char === '') return ' ';
                
                const num = parseInt(char, 10);
                if (isNaN(num)) return char;

                // Decifratura RSA: P = C^k mod N
                let decrypted = modPow(num, invExponent, modulus);

                if(method === 'modexp_secure'){
                    // Decifratura RSA: P = C^k mod N
                    decrypted = modPow(num, invExponent, modulus) - Math.floor(Math.random() * 10);
                }
                
                // Mappiamo il valore decifrato all'intervallo 0-25
                let alphabetIndex = decrypted % alphabet.length;
                
                return alphabet[alphabetIndex];
            }).join('');
        }

        const sampleTexts = [
            {
                title: "Shakespeare's Sonnet",
                text: "Shall I compare thee to a summer's day? Thou art more lovely and more temperate. Rough winds do shake the darling buds of May, And summer's lease hath all too short a date. Sometime too hot the eye of heaven shines, And often is his gold complexion dimmed; And every fair from fair sometime declines, By chance, or nature's changing course, untrimmed."
            },
            {
                title: "Scientific Statement",
                text: "The human brain is the most complex organ in the known universe. It contains approximately 86 billion neurons connected by trillions of synapses. Every thought, emotion, and action we experience emerges from the coordinated activity of these neural networks. Scientists continue to discover new aspects of brain function and organization through advanced imaging techniques and experimental studies."
            },
            {
                title: "Technology Article",
                text: "Artificial Intelligence has transformed the way we interact with technology. Machine learning algorithms now power everything from recommendation systems to autonomous vehicles. The rapid advancement of AI capabilities has sparked discussions about ethics, privacy, and the future of human work. As these systems become more sophisticated, the boundary between human and machine intelligence continues to evolve."
            },
            {
                title: "Nature Description",
                text: "The ancient redwood forest stood silent in the morning mist. Towering trees reached skyward, their branches creating a cathedral-like canopy hundreds of feet above. Soft moss carpeted the forest floor, punctuated by clusters of wild mushrooms and delicate ferns. The air was rich with the scent of damp earth and pine needles, carrying the whispers of countless generations of natural history."
            }
        ];

        function initializeWithRandomText() {
            const randomIndex = Math.floor(Math.random() * sampleTexts.length);
            const selectedText = sampleTexts[randomIndex];
            const textarea = document.getElementById('originalText');
            textarea.value = selectedText.text;
            
            // Aggiunge un menu a tendina per selezionare il testo
            const selectContainer = document.createElement('div');
            
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-white mb-2';
            label.textContent = 'Select Sample Text or Write Your Own:';
            
            const select = document.createElement('select');
            select.className = 'bg-gray-50 border border-gray-300 text-blue-600 text-sm rounded-lg focus:ring-white focus:border-white block w-full p-2.5';
            select.onchange = function() {
                const selectedText = sampleTexts[this.value];
                textarea.value = selectedText.text;
                // Chiamata automatica all'analisi quando viene selezionato un nuovo testo
                processText();
            };
            
            sampleTexts.forEach((text, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = text.title;
                option.selected = index === randomIndex;
                select.appendChild(option);
            });
            
            selectContainer.appendChild(label);
            selectContainer.appendChild(select);
            textarea.parentNode.insertBefore(selectContainer, textarea);
        }

        function getSymbolFrequency(text, cipherType) {
            const frequency = {};
            
            if (cipherType === 'modexp' || cipherType === 'modexp_secure') {
                // Split il testo in numeri separati da spazi
                const tokens = text.trim().split(' ').filter(t => t !== '');
                
                // Conta frequenza dei numeri completi
                for (let token of tokens) {
                    if (token.match(/^\d+$/)) {  // Solo numeri
                        frequency[token] = (frequency[token] || 0) + 1;
                    }
                }
            } else {
                // Solo lettere dell'alfabeto
                const cleanText = text.toLowerCase().replace(/[^a-z]/g, '');
                // Calcola la frequenza per le lettere
                for (let char of cleanText) {
                    frequency[char] = (frequency[char] || 0) + 1;
                }
            }

            // Calcola le percentuali usando il totale appropriato
            const total = Object.values(frequency).reduce((sum, count) => sum + count, 0);
            const percentages = {};
            for (let char in frequency) {
                percentages[char] = parseFloat(((frequency[char] / total) * 100).toFixed(2));
            }

            return percentages;
        }

        function createFrequencyChart(frequencies, canvasId, label, cipherType, modulus, base) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Controllo: Frequenze vuote
            if (!frequencies || Object.keys(frequencies).length === 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            data: [],
                            backgroundColor: 'rgba(255, 255, 255, 0.5)',
                            borderColor: 'rgb(255, 255, 255)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'No frequency data available',
                                padding: {
                                    top: 5,
                                    bottom: 30
                                }
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        }
                    }
                });
                return;
            }

            // Ordina le frequenze per valore decrescente
            const sortedFreqEntries = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
            const mostFrequentChar = sortedFreqEntries[0];

            let subtitleText = `Most frequent: '${mostFrequentChar[0]}'`;

            // Solo per il cifrario di Cesare, calcola la posizione alfabetica
            if (cipherType === 'caesar') {
                const alphabet = 'abcdefghijklmnopqrstuvwxyz';
                const charPosition = alphabet.indexOf(mostFrequentChar[0].toLowerCase()) + 1;
                if (charPosition > 0) {
                    subtitleText += ` (#${charPosition})`;
                }
            }

            // Per il cifrario modulare, aggiungi informazioni sul dominio
            if (cipherType === 'modexp' && modulus && base) {
                subtitleText += ` | Modulus: ${modulus}, Base: ${base}`;
            }

            // Ordina alfabeticamente per visualizzazione
            const sortedEntries = Object.entries(frequencies).sort((a, b) => a[0].localeCompare(b[0]));

            // Crea il grafico
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedEntries.map(entry => entry[0]),
                    datasets: [{
                        label: label,
                        data: sortedEntries.map(entry => entry[1]),
                        backgroundColor: 'rgba(255, 255, 255, 0.5)',
                        borderColor: 'rgb(255, 255, 255)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Character Frequency Distribution [' + subtitleText + ']',
                            padding: {
                                top: 5,
                                bottom: 30
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: value => value,
                            font: {
                                weight: 'semibold'
                            }
                        }
                    },
                    scales: {
                        x: {
                            barPercentage: 0.3,
                            categoryPercentage: 0.5,
                            title: {
                                display: true,
                                text: 'Characters or Numbers'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency (%)'
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function findMostLikelyShift(originalFreq, encryptedFreq) {
            const englishFrequencies = {
                'e': 12.02, 't': 9.10, 'a': 8.12, 'o': 7.68, 'i': 7.31,
                'n': 6.95, 's': 6.28, 'r': 6.02, 'h': 5.92, 'd': 4.32,
                'l': 3.98, 'u': 2.88, 'c': 2.71, 'm': 2.61, 'f': 2.30,
                'y': 2.11, 'w': 2.09, 'g': 2.03, 'p': 1.82, 'b': 1.49,
                'v': 1.11, 'k': 0.69, 'x': 0.17, 'q': 0.11, 'j': 0.10, 'z': 0.07
            };

            const encryptedSorted = Object.entries(encryptedFreq).sort((a, b) => b[1] - a[1]);
            const englishSorted = Object.entries(englishFrequencies).sort((a, b) => b[1] - a[1]);
            
            // Ipotizza che la lettera più frequente nel testo cifrato corrisponda alla 'e'
            const mostFrequentEncrypted = encryptedSorted[0][0];
            const expectedChar = 'e';  // 'e' è la lettera più frequente in inglese
            
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            const shift = (alphabet.indexOf(mostFrequentEncrypted) - alphabet.indexOf(expectedChar) + alphabet.length) % alphabet.length;
            
            return shift;
        }

        function animateCipher(originalText, encryptedText, elementId, method, params) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            const animationContainer = document.createElement('div');
            animationContainer.className = 'font-mono relative p-4 bg-gray-50 rounded-md';
            
            const methodIndicator = document.createElement('div');
            methodIndicator.className = 'absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-md text-sm';
            
            if (method === 'caesar') {
                methodIndicator.textContent = `Shift: ${params.shift}`;
            } else {
                methodIndicator.textContent = `PUBLIC KEY: [modulus (N) = ${params.modulus}, exponent (K) = ${params.exponent}]`;
            }
            
            animationContainer.appendChild(methodIndicator);
            
            const textContainer = document.createElement('div');
            textContainer.className = 'break-words mt-8';
            animationContainer.appendChild(textContainer);
            
            container.appendChild(animationContainer);

            const chars = originalText.split('');
            textContainer.innerHTML = chars.map(char => `<span class="inline-block">${char}</span>`).join('');
            const charSpans = textContainer.querySelectorAll('span');
            
            let currentIndex = 0;

            function transformChar() {
                if (currentIndex < chars.length) {
                    const charSpan = charSpans[currentIndex];
                    const encryptedChar = method === 'caesar' ? 
                        encryptedText[currentIndex] :
                        encryptedText.split(' ')[currentIndex] || ' ';
                    
                    charSpan.className = 'inline-block transition-all duration-300 ease-in-out text-red-500 bg-red-100';
                    setTimeout(() => {
                        charSpan.className = 'inline-block transition-all duration-300 ease-in-out transform scale-125';
                        charSpan.textContent = encryptedChar;
                        setTimeout(() => {
                            charSpan.className = 'inline-block transition-all duration-300 ease-in-out text-gray-700';
                        }, 150);
                    }, 150);

                    currentIndex++;
                    setTimeout(transformChar, 25);
                } else {
                    setTimeout(() => {
                        textContainer.innerHTML = '';
                        textContainer.textContent = encryptedText;
                        textContainer.className = 'text-red-600 mt-8';
                        const encryptedFreq = getSymbolFrequency(encryptedText, method);
                        Chart.getChart('encryptedChart')?.destroy();
                        createFrequencyChart(encryptedFreq, 'encryptedChart', 'Letter Frequency (Encrypted Text)', method, params.modulus, params.base);
                        
                        // Start decryption animation
                        if (method === 'caesar') {
                            animateDecipher(encryptedText, originalText, 'decryptedText', {
                                method: 'caesar',
                                shift: 26 - params.shift
                            });
                        } else {
                            const decryptedText = decryptModExp(encryptedText, params.base, params.exponent, params.modulus, method);
                            animateDecipher(encryptedText, decryptedText, 'decryptedText', {
                                method: 'modexp',
                                base: params.base,
                                exponent: params.exponent,
                                modulus: params.modulus
                            });
                        }
                    }, 200);
                }
            }
            
            setTimeout(transformChar, 1000);
        }

        function processText() {
            Chart.getChart('originalChart')?.destroy();
            Chart.getChart('encryptedChart')?.destroy();
            document.getElementById('decryptedText').innerHTML = '';
            document.getElementById('encryptedText').innerHTML = '';

            const originalText = document.getElementById('originalText').value;
            const method = document.getElementById('encryptionMethod').value;

            // Analisi frequenza testo originale
            const originalFreq = getSymbolFrequency(originalText, "original");
            createFrequencyChart(originalFreq, 'originalChart', 'Letter Frequency (Original Text)', method, null, null);

            let encryptedText, params;
            if (method === 'caesar') {
                const shift = parseInt(document.getElementById('shift').value) || 3;
                encryptedText = caesarCipher(originalText, shift);
                params = { shift };
            } else {
                const base = parseInt(document.getElementById('base').value) || 10;
                const exponent = parseInt(document.getElementById('exponent').value) || 7;
                const modulus = parseInt(document.getElementById('modulus').value) || 37;
                encryptedText = modExpCipher(originalText, base, exponent, modulus, method);
                params = { base, exponent, modulus };
            }

            animateCipher(originalText, encryptedText, 'encryptedText', method, params);
        }

        function animateDecipher(encryptedText, decryptedText, elementId, params) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            const animationContainer = document.createElement('div');
            animationContainer.className = 'font-mono relative p-4 bg-gray-50 rounded-md';
            
            const methodIndicator = document.createElement('div');
            methodIndicator.className = 'absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-md text-sm';
            
            if (params.method === 'caesar') {
                methodIndicator.textContent = `Inverted shift: ${params.shift}`;
            } else {
                methodIndicator.textContent = `PRIVATE KEY: [modulus (N) = ${params.modulus}, exponent (K) = ${modInverse(params.exponent, (params.modulus-1))}]`;
            }
            
            animationContainer.appendChild(methodIndicator);
            
            const textContainer = document.createElement('div');
            textContainer.className = 'break-words mt-8';
            animationContainer.appendChild(textContainer);
            
            container.appendChild(animationContainer);

            const encryptedChars = params.method === 'caesar' ? 
                encryptedText.split('') : 
                encryptedText.split(' ');
            
            textContainer.innerHTML = encryptedChars.map(char => 
                `<span class="inline-block">${char}</span>`
            ).join(params.method === 'caesar' ? '' : ' ');
            
            const charSpans = textContainer.querySelectorAll('span');
            let currentIndex = encryptedChars.length - 1;

            function transformChar() {
                if (currentIndex >= 0) {
                    const charSpan = charSpans[currentIndex];
                    const decryptedChar = params.method === 'caesar' ? 
                        decryptedText[currentIndex] : 
                        decryptedText[currentIndex];
                    
                    charSpan.className = 'inline-block transition-all duration-300 ease-in-out text-green-500 bg-green-100';
                    setTimeout(() => {
                        charSpan.className = 'inline-block transition-all duration-300 ease-in-out transform scale-125';
                        charSpan.textContent = decryptedChar;
                        setTimeout(() => {
                            charSpan.className = 'inline-block transition-all duration-300 ease-in-out text-gray-700';
                        }, 150);
                    }, 150);

                    currentIndex--;
                    setTimeout(transformChar, 25);
                } else {
                    setTimeout(() => {
                        textContainer.innerHTML = '';
                        textContainer.textContent = decryptedText;
                        textContainer.className = 'text-green-600 mt-8';
                    }, 200);
                }
            }
            
            setTimeout(transformChar, 1000);
        }

        // Initialize parameters on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateParameters();
            initializeWithRandomText();
        });
    </script>
    <script src="background.js"></script>
</body>
</html>